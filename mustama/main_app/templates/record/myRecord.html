{% extends 'base.html' %}
{% block content %}
<main>
    <h1>Record List</h1>

    <a href="{% url 'insert' %}" class="insert-btn">Insert Record</a>
  
    {% for record in records %}
    <div class="card-index">
        <div class="card-left">
            <div class="reciter-image">
                {% load static %}
                <img src="{% static record.reciterImage|cut:'main_app/static/' %}" alt="reciter Image">
            </div>
            <div class="title">
                {{ record.surahName }} - {{ record.Reciter }}
                <div class="play-audio">
                    <audio id="play-{{ forloop.counter0 }}">
                        <source src="{% static record.audio|cut:'main_app/static/' %}">
                    </audio>
                    <img src="{% static 'uploads/pictures/play.png' %}"
                         alt=""
                         id="play-image-{{ forloop.counter0 }}"  
                         data-index="{{ forloop.counter0 }}">
                        </div>
                        <p>description:</p>
                <p>{{ record.description }}</p>
                    </div>
        </div>

        <div class="card-right">
            {% if record.approval == "APPROVED" %}
            <img src="{% static 'uploads/pictures/approved.svg' %}" alt="">
            {% elif record.approval == "PENDING" %}
            <img src="{% static 'uploads/pictures/Pending.png' %}" alt="">
            {% elif record.approval == "REJECTED" %}
            <img src="{% static 'uploads/pictures/notApproved.png' %}" alt="">
            {% endif %}
        </div>

    </div>
    {% endfor %}
</main>

<script>
let playedAudio = false;
let index = -1;
let selectedIndex = -1;

document.querySelectorAll(".play-audio").forEach(playAudio => {

    const playSurah = (event) => {
        const clickedIndex = event.target.getAttribute("data-index");

        if (clickedIndex == selectedIndex && !playedAudio) {
            index = clickedIndex;
            playThisSurah(index);
        }
        else if (clickedIndex == selectedIndex && playedAudio) {
            pauseThisSurah();
            index = -1;
            selectedIndex = -1;
        }
        else if (clickedIndex != selectedIndex) {
            index = clickedIndex;
            playNewSurah(selectedIndex, index);
        }
    }
    //play surah if there is no surah are played
    const playThisSurah = (position) => {
        const audio = document.querySelector(`#play-${position}`);
        const image = document.querySelector(`#play-image-${position}`);
        if (!audio || !image) return;
        selectedIndex = position;
        playedAudio = true;
        audio.play();
        image.src = "{% static 'uploads/pictures/pause.svg' %}";

        // Reset icon when audio ends
        audio.onended = () => {
            playedAudio = false;
            image.src = "{% static 'uploads/pictures/play.png' %}";
            selectedIndex = -1;
            index = -1;
        };
    }
    // pause the surah that are clicked twice
    const pauseThisSurah = () => {
        const audio = document.querySelector(`#play-${selectedIndex}`);
        const image = document.querySelector(`#play-image-${selectedIndex}`);
        if (!audio || !image) return;
        playedAudio = false;
        audio.pause();
        image.src = "{% static 'uploads/pictures/play.png' %}";
    }
    // change the surah to another and pause the prevoius record
    const playNewSurah = (oldValue, newValue) => {
        if (oldValue !== -1) {
            const oldAudio = document.querySelector(`#play-${oldValue}`);
            const oldImage = document.querySelector(`#play-image-${oldValue}`);
            if (oldAudio) oldAudio.pause();
            if (oldImage) oldImage.src = "{% static 'uploads/pictures/play.png' %}";
        }
        playThisSurah(newValue);
    }

    playAudio.addEventListener("click", playSurah);
});
</script>
{% endblock %}
