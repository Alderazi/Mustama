{% extends 'base.html' %}
{% block content %}
<main>
  <h1>Record List</h1>
  
  {% for record in records %}
    <div class="card-index">
      <div class="reciter-image">
        {% load static %}
        <img src="{% static record.reciterImage|cut:'main_app/static/' %}" width="100px" height="100px" alt="reciter Image">
      </div>
      <div class="title"> 
        {{ record.surahName }} - {{ record.Reciter }}
        <div class="play-audio">
          <audio id="play-{{ forloop.counter0 }}">
            <source src="{% static record.audio|cut:'main_app/static/' %}">
          </audio>
          <img src="{% static 'uploads/pictures/play.png' %}" 
               style="width: 50px; height: 50px;" 
               alt="" 
               id="play-image-{{ forloop.counter0 }}"  
               data-index="{{ forloop.counter0 }}">
        </div>
      </div>

      {% if user.is_staff %}
        <a href="{% url 'recordUpdate' record.id %}">edit</a>
        <a href="{% ur %}">delete</a>
      {% endif %}
    </div>
  {% endfor %}
</main>

<script>
let playedAudio = false;
let index = -1;
let selectedIndex = -1;

document.querySelectorAll(".play-audio").forEach(playAudio => {

    const playSurah = (event) => {
        const clickedIndex = event.target.getAttribute("data-index");

        if (clickedIndex == selectedIndex && !playedAudio) {
            index = clickedIndex;
            playThisSurah(index);
        }
        else if (clickedIndex == selectedIndex && playedAudio) {
            pauseThisSurah();
            index = -1;
            selectedIndex = -1;
        }
        else if (clickedIndex != selectedIndex) {
            index = clickedIndex;
            playNewSurah(selectedIndex, index);
        }
    }

    const playThisSurah = (position) => {
        const audio = document.querySelector(`#play-${position}`);
        const image = document.querySelector(`#play-image-${position}`);
        if (!audio || !image) return;
        selectedIndex = position;
        playedAudio = true;
        audio.play();
        image.src = "{% static 'uploads/pictures/pause.svg' %}";
    }

    const pauseThisSurah = () => {
        const audio = document.querySelector(`#play-${selectedIndex}`);
        const image = document.querySelector(`#play-image-${selectedIndex}`);
        if (!audio || !image) return;
        playedAudio = false;
        audio.pause();
        image.src = "{% static 'uploads/pictures/play.png' %}";
    }

    const playNewSurah = (oldValue, newValue) => {
        if (oldValue !== -1) {
            const oldAudio = document.querySelector(`#play-${oldValue}`);
            const oldImage = document.querySelector(`#play-image-${oldValue}`);
            if (oldAudio) oldAudio.pause();
            if (oldImage) oldImage.src = "{% static 'uploads/pictures/play.png' %}";
        }
        playThisSurah(newValue);
    }

    playAudio.addEventListener("click", playSurah);
});
</script>
{% endblock %}
